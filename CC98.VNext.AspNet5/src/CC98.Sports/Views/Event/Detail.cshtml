@using System.Globalization
@using CC98

@model Event
@inject AppSettingService<SystemSetting> SettingService

@{
	ViewBag.Title = string.Format(CultureInfo.CurrentCulture, "赛事详细信息 - {0}", Model.Name);
}

<h1 class="page-header lead text-center">@ViewBag.Title</h1>

<div asp-message-list="MessageListStyle.AlertDialogClosable"></div>

@if (!string.IsNullOrEmpty(Model.Description))
{
	<p style="font-size: large;">@Model.Description</p>
}

@if (!string.IsNullOrEmpty(Model.Link))
{
	<a href="@Model.Link" target="_blank" class="btn btn-default btn-primary">访问赛事官方网站</a>
}

<h2>基本信息</h2>

<table class="table table-striped table-hover">
	<tbody>
		<tr>
			<th>赛事编号</th>
			<td>@Model.Id.ToString(SettingService.Current.EventIdFormat, CultureInfo.CurrentCulture)</td>
		</tr>
		<tr>
			<th>赛事名称</th>
			<td>@Model.Name</td>
		</tr>
		<tr>
			<th>赛事类型</th>
			<td>
				@switch (Model.Type)
			{
				case EventType.Cup:
						<span>杯赛</span>
					break;
				case EventType.League:
						<span>联赛</span>
					break;
			}
			</td>
		</tr>
		<tr>
			<th>允许队伍上限</th>
			<td>
				@if (Model.MaxTeamCount == null)
			{
					<span class="text-muted">无限制</span>
			}
			else
			{
					<span>@Model.MaxTeamCount.Value</span>
			}
			</td>
		</tr>
		<tr>
			<th>开放队伍报名</th>
			<td>
				@if (Model.AllowTeamRegistrations)
			{
					<span class="text-success">是</span>
			}
			else
			{
					<span class="text-muted">否</span>
			}
			</td>
		</tr>
	</tbody>
</table>

<hr />

<div class="alert alert-info">以下是和队伍报名相关的一些设定要求。注意：除了此处的设定之外，管理员可能对于报名表具有其它额外要求，这些要求无法通过系统自动验证，请确保你详细阅读了报名相关的通知，以免被管理员在审核时驳回申请。</div>

<table class="table table-striped table-hover">
	<tbody>
		<tr>
			<th>队伍运动员数量上限</th>
			<td>
				@if (Model.PlayerMax != null)
			{
					<span>@Model.PlayerMax.Value</span>
			}
			else
			{
					<span class="text-muted">不限</span>
			}
			</td>
		</tr>
		<tr>
			<th>队伍运动员数量下限</th>
			<td>
				@if (Model.PlayerMin != null)
			{
					<span>@Model.PlayerMin.Value</span>
			}
			else
			{
					<span class="text-muted">不限</span>
			}
			</td>
		</tr>
		<tr>
			<th>队伍专业运动员数量上限</th>
			<td>
				@if (Model.ProfessionalMax != null)
			{
					<span>@Model.ProfessionalMax.Value</span>
			}
			else
			{
					<span class="text-muted">不限</span>
			}
			</td>
		</tr>
		<tr>
			<th>队伍外籍运动员数量上限</th>
			<td>
				@if (Model.ForeignMax != null)
			{
					<span>@Model.ForeignMax.Value</span>
			}
			else
			{
					<span class="text-muted">不限</span>
			}
			</td>
		</tr>
		<tr>
			<th>队伍外援数量上限</th>
			<td>
				@if (Model.ExternalMax != null)
			{
					<span>@Model.ExternalMax.Value</span>
			}
			else
			{
					<span class="text-muted">不限</span>
			}
			</td>
		</tr>
	</tbody>
</table>

<hr />

<h2>队伍报名情况</h2>
<p>下面列出了这次赛事目前已经报名参加的所有队伍，以及他们的报名状态。</p>

@if (Model.TeamRegistrations.Any())
{
	ViewBag.ShowTeam = true;
	ViewBag.ShowEvent = false;
	ViewBag.ShowAdmin = User.CanOperate();
	ViewBag.ShowAuditState = User.CanOperate();
	ViewBag.ForceAdmin = true;

	var teamList = Model.TeamRegistrations.OrderBy(p => p.Group).ThenBy(p => p.GroupNumber).ThenBy(p => p.Team.Name).ToPagedList(SettingService.Current.PageSize, (int)ViewBag.TeamPage);

	@await Html.PartialAsync("_EventTeamApplyListPartial", teamList)

	<nav asp-pager-source="teamList" asp-pager-link-parameter-name="TeamPage"></nav>

	if (User.CanOrganize())
	{
		<a asp-controller="Event" asp-action="GroupTeams" asp-route-id="@Model.Id" class="btn btn-primary">管理队伍分组情况</a>
	}
}
else
{
	<p class="text-muted text-center">目前还没有队伍报名参赛。</p>
}

@if (User.Identity.IsAuthenticated)
{
	<hr />

	if (Model.AllowTeamRegistrations && Model.State == EventState.Registring)
	{
		<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#team-apply-event-modal">带领我的队伍报名参赛</button>
		@await Component.InvokeAsync("TeamEventApply", Model.Id)
	}
	else
	{
		<p class="text-muted text-center">目前该赛事不接受队伍报名。如果你希望带领队伍参赛，请联系系统管理员。</p>
	}
}

<hr />
<h2>赛程安排</h2>
<p>下表列出了目前该赛事中已经计划或举行的赛程。若要观看完整赛程表，请访问 <a asp-controller="Game" asp-action="Index" asp-route-eventId="@Model.Id">比赛日程一览</a> 页面。</p>

@if (Model.Games.Any())
{

	var gamesList = Model.Games.OrderBy(i => i.Round).ThenBy(i => i.Id).ToPagedList(SettingService.Current.PageSize, (int)ViewBag.GamePage);

	ViewBag.ShowEvent = false;
	@await Html.PartialAsync("_GameListPartial", gamesList, ViewData)

	<nav asp-pager-source="gamesList" asp-pager-link-parameter-name="GamePage"></nav>
}
else
{
	<p class="text-muted text-center">目前该赛事还没有计划任何赛程。</p>
}

@if (User.CanOrganize())
{
	<hr />
	<a asp-controller="Game" asp-action="Create" asp-route-eventId="@Model.Id" class="btn btn-primary">创建新赛程</a>
	<a asp-controller="Game" asp-action="AutoGenerate" asp-route-eventId="@Model.Id" class="btn btn-default">自动生成赛程</a>
	<a asp-controller="Game" asp-action="BatchEdit" asp-route-eventId="@Model.Id" class="btn btn-default">批量编辑赛程</a>
	<button type="button" class="btn btn-danger" data-toggle="modal" data-target="#clear-games-dialog">清空所有赛程</button>

	<form asp-controller="Game" asp-action="Clear" asp-route-eventId="@Model.Id" method="post" asp-antiforgery="true" id="clear-games-form">

		<div class="modal fade" id="clear-games-dialog">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-label="关闭"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title">清空赛程警告</h4>
					</div>
					<div class="modal-body">
						<p>你确定要清空赛事的所有赛程吗？清空赛程后，所有官员的比赛报名申请、队伍的参赛名单等都将被一并删除。这个操作无法撤销。如果你确定要继续，请单击 <q>确认清空赛程</q> 按钮。否则，请单击 <q>关闭</q> 按钮或单击对话框外的任意位置。</p>
					</div>
					<div class="modal-footer">
						<p class="text-danger" id="dialog-error-text"></p>
						<button type="submit" class="btn btn-danger">确认清空赛程</button>
						<button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
					</div>
				</div><!-- /.modal-content -->
			</div><!-- /.modal-dialog -->
		</div><!-- /.modal -->

	</form>

}

@section scripts{

	@await Html.PartialAsync("_ValidationScriptsPartial")
	@await Html.PartialAsync("_AjaxPartial")


	@if (User.Identity.IsAuthenticated && Model.AllowTeamRegistrations)
	{
		<script type="text/javascript" language="javascript">

			$(document).ready(function () {

				$('#team-apply-event-form').ajaxForm({

					success: function () {
						window.location.reload();
					},

					error: function (xhr) {
						$('#dialog-error-text').text(getErrorText(xhr));
					}

				});

			});

		</script>
	}

}